import{C as D,D as U,E as k,G as W,L as ae,H as oe,I as H,J as G,K as se,n as z,m as re,g as ie,A as le,M as ce,N as ue,O as fe,T as de,P as pe,Q as me,a as L,R as ge,S as ye,b as be,c as he,f as _e}from"./index-CAkezAZH.js";import{d as Q,x as X,r as $,g as B,b as x,k as I,i as b,u as C,m as h,h as j,j as J,F as Y,l as Z,A as ee,c as y,o as we,C as ve,s as ke,e as Ce,p as Se}from"./element-plus-CwxVOKr1.js";import{r as Fe}from"./common-DBJIaUxx.js";import{_ as Oe}from"./Table.vue_vue_type_script_setup_true_lang-hndptxFW.js";const Te={name:"TableForm"},De=Q({...Te,props:{config:{type:Object,default:()=>D()},type:{type:String},editMode:{type:Boolean},disabled:{type:Boolean}},setup(V,{expose:q}){const o=V,S=X(),f=$({config:D(),form:{},rules:{}});let F;function N(e){S.value&&S.value.validate(c=>{if(c&&e){let s=O.value,l={};if(E.value.forEach(i=>{const p=i.valueType==="string"?[void 0]:["",void 0];let T=s[i.key];p.includes(T)&&(T=null),l[i.key]=T}),s=H(s),l=H(l),F){const i=JSON.parse(JSON.stringify(F));re(i,s),e(i,l)}else e(s,l)}})}function g(){setTimeout(()=>{var e;(e=S.value)==null||e.clearValidate()})}function P(){f.config.fields.forEach(G)}function A(e){F=e;const c=[void 0,null,""];f.config.fields.forEach(s=>{if(Object.prototype.hasOwnProperty.call(e,s.key)){const l=se(e,s.key);if(c.includes(l))return;switch(s.type){case"date":k(l,"array")?s.value=l.map(i=>new Date(i)):s.value=new Date(l);break;default:s.value=l;break}}s.defaultValue=z(s.value)}),g()}function R(e){f.config=z(e||D());const c=f.config.fields||[],s={},l={},i=["input","input-between","textarea"];c.forEach(p=>{s[p.key]=p.value,p.required&&(l[p.key]=[{required:!0,validator(T,v,m){const K=[void 0,null,""];if(p.type==="input-between"&&!p.value[0]&&!p.value[1]){m(new Error("请输入两个范围字段"));return}if(p.valueType==="array"&&!p.value.length){m(new Error(p.placeholder||"请选择"));return}if(p.valueType!=="boolean"&&K.includes(p.value)){const M=i.includes(p.type)?"请输入内容":"请选择";m(new Error(p.placeholder||M));return}m()},trigger:i.includes(p.type)?"blur":"change"}])}),f.form=s,f.rules=l,g()}const O=B(()=>{const e={};return f.config.fields.forEach(c=>{e[c.key]=U(c).value}),e}),E=B(()=>f.config.fields.filter(e=>{const c=e.show;if(!c)return!0;if(k(c,"function"))return c(O.value);if(c.includes("return"))try{return new Function("formData",c)(O.value)}catch(s){console.warn("解析表单展示逻辑代码错误 >>",s)}return!0}));function _(e){if(typeof e!="string")return e;if(e.includes("return"))try{return new Function("formData",e)(O.value)}catch(c){console.warn("解析表单项禁用代码错误 >>",c)}}return q({update:R,validate:N,reset:P,setFormData:A}),(e,c)=>{const s=x("el-form-item"),l=x("el-form");return b(),I(l,{ref_key:"formRef",ref:S,model:f.form,rules:f.rules,"label-width":C(W)(f.config.labelWidth),"label-position":f.config.labelPosition,disabled:o.disabled},{default:h(()=>[f.config&&f.config.fields?(b(!0),j(Y,{key:0},Z(E.value,i=>(b(),I(s,{key:i.id,label:i.label,prop:i.key},ee({default:h(()=>[y(oe,{fieldData:i,disabled:_(i.disabled)},null,8,["fieldData","disabled"])]),_:2},[i.label&&i.tooltip?{name:"label",fn:h(()=>[y(C(ae),{label:i.label,tips:i.tooltip},null,8,["label","tips"])]),key:"0"}:void 0]),1032,["label","prop"]))),128)):J("",!0)]),_:1},8,["model","rules","label-width","label-position","disabled"])}}}),Ee={class:"the-curd-main-page"},Le=["innerHTML"],xe=Se("i",{class:"el-icon-arrow-left"},null,-1),Ie={name:"Curd"},Je=Q({...Ie,props:{data:{type:Object,required:!0},action:{type:Object,required:!0},pageId:{type:String,required:!0}},emits:["update:data"],setup(V,{emit:q}){const o=V,S=q,f=$({loading:!1});function F(n){me({title:"低代码配置",config:o.data,pageId:o.pageId,type:n,callback(t){S("update:data",t)}})}function N(n){n&&o.data.search.list.forEach(G),g.pageInfo.currentPage=1,g.selectList=[],v()}const g=$({selectList:[],data:[],pageInfo:ie()});function P(n){return o.data.table.columns.find(a=>a.prop===n)||{}}function A(n,t){let a="-";const r=P(t);if(!r.jsCode)return a;try{a=new Function("cellValue","row",r.jsCode)(n[t],n)}catch(d){console.warn("解析 rawContent 代码错误 >>",d)}return a}function R(n,t){const a="preview-image-",r=t.replace(a,""),d=[];return E.value.forEach(u=>{u.includes(a)&&d.push(n[u.replace(a,"")])}),{column:P(r),src:n[r],previewList:d}}const O=B(()=>o.data.table.actions.map(t=>{const a={...t};return a.key===le&&(a.click=function(r){l(r)}),k(a.formConfig,"object")&&(a.click=function(r){l(r,a.formConfig)}),a})),E=B(()=>{const n=[];return o.data.table.columns.forEach(t=>{t.slot&&n.push(t.slot)}),n}),_=X(),e=$({type:"add",loading:!1,show:!1,config:D()});let c=function(){},s=null;function l(n,t){var u;s=n?JSON.parse(JSON.stringify(n)):{};const a=o.data.table,r=a.formAdd||D(),d=a.formEdit||D();k(t,"object")?(e.config=t,e.type="other"):(e.type=n?"edit":"add",e.config=JSON.parse(JSON.stringify(n?d:r))),e.show=!0,(u=_.value)==null||u.update(e.config),JSON.stringify(s)!=="{}"&&_.value?c=function(){var w;(w=_.value)==null||w.setFormData(s)}:c=function(){}}function i(){var n;(n=_.value)==null||n.reset(),e.show=!1,s=null,m.selects=m.list=[]}function p(){var n;(n=_.value)==null||n.validate(async(t,a)=>{let r;if(e.type==="add"&&o.action.onAdd&&(r=o.action.onAdd),e.type==="edit"&&o.action.onEdit&&(r=o.action.onEdit),r){e.loading=!0;const d=await r(t,a);if(e.loading=!1,d.code!==1)return;i(),v()}else{const d=e.config.submitCode,u=e.config.title?`【${e.config.title}】`:"表单";if(!d)return L.error(`未找到对应的${u}提交代码！`);try{new Function("formData","current","other",d)(t,a,m)}catch(w){console.warn("表单提交代码出错 >>",w)}}})}function T(){const n=o.data.search.list,t={};for(let a=0;a<n.length;a++){const r=n[a],d=U(r);if(r.required&&k(d.result,"string"))return ge(document.querySelector(`.${r.id}`)),L.error(d.result),null;d.result===!0&&(t[r.key]=d.value)}return t}async function v(){const n=T();if(!n)return;const t=o.data.search.validateCode;if(t&&new Function("params",t)(n)===!1)return;const a=JSON.parse(JSON.stringify(g.pageInfo));f.loading=!0;const r=await o.action.getTableData(n,a);f.loading=!1,r.code===1&&(g.pageInfo.total=r.data.total,g.data=r.data.list||[])}const m={selects:[],list:[]};function K(n,t){switch(n){case"add":l();break;case"batch":if(m.selects=JSON.parse(JSON.stringify(g.selectList)),!m.selects.length)return L.warning("请选择要操作的列！");if(!t)return L.error("当前按钮未配置动态代码或表单配置！");if(m.list=m.selects.map(a=>a[o.data.table.selectKey]),k(t,"object")){l(void 0,t);return}if(k(t,"function")){t(m.list,m.selects);return}try{new Function("list","selectList",t)(m.list,m.selects)}catch(a){console.warn("批量操作代码出错 >>",a)}break;case"open-form":l(void 0,t);break}}function M(n){f.loading=n}function te(n){e.loading=n}const ne={};return ce({formatDate:_e,copyText:he,messageBox:be,message:L,jsonToPath:ye,request:Fe,[o.pageId]:{onSearch:N,getData:v,setLoading:M,setFormLoading:te,openForm:l,closeForm:i,cellFn:ne}}),we(function(){o.action.created&&o.data.table.columns.length&&o.action.created(v)}),(n,t)=>{const a=x("el-button"),r=x("el-empty"),d=x("base-dialog");return b(),j("div",Ee,[o.data.search.list.length?(b(),I(ue,{key:0,search:o.data.search,loading:f.loading,onSearch:N},null,8,["search","loading"])):J("",!0),o.data.table.columns.length>0?(b(),j(Y,{key:1},[y(fe,{config:o.data.table,disabled:f.loading,onAction:K},null,8,["config","disabled"]),y(C(Oe),{class:"f1","select-list":g.selectList,"onUpdate:selectList":t[0]||(t[0]=u=>g.selectList=u),data:g.data,columns:o.data.table.columns,actions:O.value,"action-max":o.data.table.actionMax,loading:f.loading,"select-key":o.data.table.selectKey,"page-info":g.pageInfo,onPage:t[1]||(t[1]=u=>v()),onSort:t[2]||(t[2]=u=>v())},ee({_:2},[Z(E.value,u=>({name:u,fn:h(({row:w})=>[u.includes("preview-image-")?(b(),I(C(de),ve(ke({key:0},R(w,u))),null,16)):J("",!0),u.includes("render-cell-")?(b(),j("div",{key:1,innerHTML:A(w,u.replace("render-cell-",""))},null,8,Le)):J("",!0)])}))]),1032,["select-list","data","columns","actions","action-max","loading","select-key","page-info"])],64)):(b(),I(r,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:h(()=>[y(a,{type:"primary",onClick:t[3]||(t[3]=u=>F("table"))},{default:h(()=>[Ce("去配置")]),_:1})]),_:1})),y(a,{class:"the-curd-entrance",type:"primary",size:"small",onClick:t[4]||(t[4]=u=>F())},{default:h(()=>[xe]),_:1}),y(d,{show:e.show,"onUpdate:show":t[5]||(t[5]=u=>e.show=u),title:e.config.title,width:C(W)(e.config.width),onClose:i,onOpened:C(c)},{footer:h(()=>[y(C(pe),{loading:e.loading,onClose:i,onSubmit:p},null,8,["loading"])]),default:h(()=>[y(De,{ref_key:"formRef",ref:_,disabled:e.loading},null,8,["disabled"])]),_:1},8,["show","title","width","onOpened"])])}}});export{Je as _};
