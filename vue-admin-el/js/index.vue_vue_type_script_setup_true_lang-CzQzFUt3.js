import{z as F,A as W,B as j,C as G,D as te,E as Q,k as z,g as ne,x as oe,G as ae,H as se,I as re,J as ie,T as le,K as ce,L as ue,a as C,b as U,M as fe,N as de,c as pe,f as ge}from"./index-BtL-sgCI.js";import{d as X,x as Y,r as $,g as D,b as T,k as B,i as w,u as x,m as b,h as R,j as Z,F as ee,l as K,c as h,o as me,A as ye,e as ve,p as he}from"./element-plus-DM0gVeuf.js";import{r as be}from"./common-9ussxiSp.js";import{_ as _e}from"./Table.vue_vue_type_script_setup_true_lang-07Br81Rg.js";const we={name:"TableForm"},ke=X({...we,props:{config:{type:Object,default:()=>F()},type:{type:String},editMode:{type:Boolean},disabled:{type:Boolean}},setup(J,{expose:A}){const c=J,L=Y(),i=$({config:F(),form:{},rules:{}});function N(s){var e;(e=L.value)==null||e.validate(u=>{if(u&&s){let p=k.value,g={};E.value.forEach(l=>{g[l.key]=p[l.key]}),s(p,g)}})}function I(){setTimeout(()=>{var s;(s=L.value)==null||s.clearValidate()})}function d(){i.config.fields.forEach(Q)}function m(s){i.config.fields.forEach(e=>{if(Object.prototype.hasOwnProperty.call(s,e.key)){const u=s[e.key];if(!u)return;switch(e.type){case"date":j(u,"array")?e.value=u.map(p=>new Date(p)):e.value=new Date(u);break;default:e.value=u;break}}e.defaultValue=z(e.value)}),I()}function O(s){i.config=z(s||F());const e=i.config.fields||[],u={},p={},g=["input","input-between","textarea"];e.forEach(l=>{u[l.key]=l.value,l.required&&(p[l.key]=[{required:!0,validator(M,H,y){const V=[void 0,null,""];if(l.type==="input-between"&&!l.value[0]&&!l.value[1]){y(new Error("请输入两个范围字段"));return}if(l.valueType==="array"&&!l.value.length){y(new Error(l.placeholder||"请选择"));return}if(l.valueType!=="boolean"&&V.includes(l.value)){const q=g.includes(l.type)?"请输入内容":"请选择";y(new Error(l.placeholder||q));return}y()},trigger:g.includes(l.type)?"blur":"change"}])}),i.form=u,i.rules=p,I()}const k=D(()=>{const s={};return i.config.fields.forEach(e=>{s[e.key]=W(e).value}),s}),E=D(()=>i.config.fields.filter(s=>{const e=s.show;if(!e)return!0;if(j(e,"function"))return e(k.value);if(e.includes("return"))try{return new Function("formData",e)(k.value)}catch(u){console.warn("解析表单展示逻辑代码错误 >>",u)}return!0}));function P(s){if(typeof s!="string")return s;if(s.includes("return"))try{return new Function("formData",s)(k.value)}catch(e){console.warn("解析表单项禁用代码错误 >>",e)}}return A({update:O,validate:N,reset:d,setFormData:m}),(s,e)=>{const u=T("el-form-item"),p=T("el-form");return w(),B(p,{ref_key:"formRef",ref:L,model:i.form,rules:i.rules,"label-width":x(G)(i.config.labelWidth),"label-position":i.config.labelPosition,disabled:c.disabled},{default:b(()=>[i.config&&i.config.fields?(w(!0),R(ee,{key:0},K(E.value,g=>(w(),B(u,{key:g.id,label:g.label,prop:g.key},{default:b(()=>[h(te,{fieldData:g,disabled:P(g.disabled)},null,8,["fieldData","disabled"])]),_:2},1032,["label","prop"]))),128)):Z("",!0)]),_:1},8,["model","rules","label-width","label-position","disabled"])}}}),Ee={class:"the-curd-main-page"},Se=he("i",{class:"el-icon-arrow-left"},null,-1),Ce={name:"Curd"},Oe=X({...Ce,props:{data:{type:Object,required:!0},action:{type:Object,required:!0}},emits:["update:data"],setup(J,{emit:A}){const c=J,L=A,i=$({loading:!1});function N(n){ue({title:"低代码配置",config:c.data,type:n,callback(t){L("update:data",t)}})}function I(n){n&&c.data.search.list.forEach(Q),d.pageInfo.currentPage=1,d.selectList=[],y()}const d=$({selectList:[],data:[],pageInfo:ne()}),m=D(()=>c.data.table),O=D(()=>m.value.columns.filter(t=>t.visible).map(t=>{const o={...t};return o.cellType==="js"&&o.jsCode&&(o.rawContent=function(f,v){let r="";try{r=new Function("cellValue","row",o.jsCode)(f,v)}catch(a){console.warn("解析 rawContent 代码错误 >>",a),r="-"}return r}),o})),k=D(()=>m.value.actions.map(t=>{const o={...t};return o.key===oe&&(o.click=function(f){g(f)}),o})),E=D(()=>{const n=[],t=[];return O.value.forEach(o=>{o.slotHead&&n.push(o.slotHead),o.slot&&t.push(o.slot)}),{head:n,cell:t}});function P(n){return m.value.columns.find(o=>o.prop===n)||{}}const s=Y(),e=$({type:"add",loading:!1,show:!1,config:F()});let u=function(){},p=null;function g(n,t){var r;p=n?JSON.parse(JSON.stringify(n)):{};const o=m.value,f=o.formAdd||F(),v=o.formEdit||F();j(t,"object")?(e.config=t,e.type="other"):(e.type=n?"edit":"add",e.config=JSON.parse(JSON.stringify(n?v:f))),e.show=!0,(r=s.value)==null||r.update(e.config),JSON.stringify(p)!=="{}"&&s.value?u=function(){var a;(a=s.value)==null||a.setFormData(p)}:u=function(){}}function l(){var n;e.show=!1,(n=s.value)==null||n.reset(),p=null}function M(){var n;(n=s.value)==null||n.validate(async(t,o)=>{let f;if(e.type==="add"&&c.action.onAdd&&(f=c.action.onAdd),e.type==="edit"&&c.action.onEdit&&(f=c.action.onEdit),f){e.loading=!0;const v=await f(t,o);if(e.loading=!1,v.code!==1)return;l(),y()}})}function H(n){const t=c.data.search.list,o={};for(let a=0;a<t.length;a++){const _=t[a],S=W(_);if(_.required&&j(S.result,"string"))return fe(document.querySelector(`.${_.id}`)),C.error(S.result),n&&n.key==="page"&&(d.pageInfo=n.before),null;S.result===!0&&(o[_.key]=S.value)}const f=m.value.columns,v=[],r=[];return n&&n.key==="sort"?f.forEach(a=>{a.sort&&(a.prop===n.prop?a.sort=n.action:a.sort=!0),a.sort==="asc"&&v.push(a.prop),a.sort==="desc"&&r.push(a.prop)}):f.forEach(a=>{a.sort==="asc"&&v.push(a.prop),a.sort==="desc"&&r.push(a.prop)}),v.length&&(o.asc=v.toString()),r.length&&(o.desc=r.toString()),o}async function y(n){const t=H(n);if(!t)return;const o=JSON.parse(JSON.stringify(d.pageInfo));i.loading=!0;const f=await c.action.getTableData(t,o);i.loading=!1,f.code===1&&(d.pageInfo.total=f.data.total,d.data=f.data.list||[])}function V(n){const t=d.selectList;switch(n){case"add":g();break;case"delete":if(!t.length)return C.warning("请选择要删除的列表再进行操作~");U({title:"操作提示",content:`是否删除选中的 ${t.length} 条数据？`,cancelText:"取消",async confirm(){c.action.onDelete?(i.loading=!0,(await c.action.onDelete(JSON.parse(JSON.stringify(d.selectList)))).code===1?(C.success("删除成功！"),d.selectList=[],y()):i.loading=!1):C.info("请设置 action.onDelete 删除逻辑")}});break;case"export":c.action.onExport?c.action.onExport():C.info("请设置 action.onExport 导出逻辑");break}}function q(n){i.loading=n}return ae({formatDate:ge,copyText:pe,messageBox:U,message:C,jsonToPath:de,request:be,getData:y,setLoading:q}),me(function(){c.action.created&&m.value.columns.length&&c.action.created(y)}),(n,t)=>{const o=T("el-button"),f=T("el-empty"),v=T("base-dialog");return w(),R("div",Ee,[c.data.search.list.length?(w(),B(se,{key:0,search:c.data.search,loading:i.loading,onSearch:I},null,8,["search","loading"])):Z("",!0),m.value.columns.length>0?(w(),R(ee,{key:1},[h(re,{config:m.value,disabled:i.loading,onAction:V},null,8,["config","disabled"]),h(x(_e),{class:"f1","select-list":d.selectList,"onUpdate:selectList":t[1]||(t[1]=r=>d.selectList=r),data:d.data,columns:O.value,actions:k.value,"action-max":m.value.actionMax,loading:i.loading,"select-key":m.value.selectKey,"page-info":d.pageInfo,onPage:t[2]||(t[2]=r=>y({key:"page",...r}))},ye({_:2},[K(E.value.head,r=>({name:r,fn:b(({$index:a})=>[h(ie,{column:O.value[m.value.selectKey?a-1:a],onSort:t[0]||(t[0]=(_,S)=>y({key:"sort",prop:_,action:S}))},null,8,["column"])])})),K(E.value.cell,r=>({name:r,fn:b(({row:a})=>[h(x(le),{column:P(r),src:a[r],previewList:E.value.cell.map(_=>a[_])},null,8,["column","src","previewList"])])}))]),1032,["select-list","data","columns","actions","action-max","loading","select-key","page-info"])],64)):(w(),B(f,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:b(()=>[h(o,{type:"primary",onClick:t[3]||(t[3]=r=>N("table"))},{default:b(()=>[ve("去配置")]),_:1})]),_:1})),h(o,{class:"the-curd-entrance",type:"primary",size:"small",onClick:t[4]||(t[4]=r=>N())},{default:b(()=>[Se]),_:1}),h(v,{show:e.show,"onUpdate:show":t[7]||(t[7]=r=>e.show=r),title:e.config.title,width:x(G)(e.config.width),onClose:l,onAfterEnd:x(u)},{footer:b(()=>[h(x(ce),{loading:e.loading,onClose:t[5]||(t[5]=r=>l()),onSubmit:t[6]||(t[6]=r=>M())},null,8,["loading"])]),default:b(()=>[h(ke,{ref_key:"formRef",ref:s,disabled:e.loading},null,8,["disabled"])]),_:1},8,["show","title","width","onAfterEnd"])])}}});export{Oe as _};
