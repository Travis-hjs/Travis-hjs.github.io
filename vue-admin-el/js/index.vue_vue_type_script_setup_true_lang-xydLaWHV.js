import{L as I,M as H,N as O,O as W,P as ae,Q as se,R as K,S as Q,T as re,t as U,m as ie,a as D,e as le,I as ce,U as ue,V as fe,W as de,X as pe,Y as me,Z as ge,$ as ye,a0 as be,q as he,a1 as ve,a2 as we,a3 as _e,b as ke,c as Se,f as Ce}from"./index-C24nMwOO.js";import{d as X,x as Y,r as B,g as q,b as $,k as P,i as _,u as x,m as k,h as J,j as V,F as Z,l as G,A as ee,c as w,o as Fe,C as Te,s as Oe,e as xe,p as Ee}from"./element-plus-CwxVOKr1.js";import{_ as Le}from"./Table.vue_vue_type_script_setup_true_lang-R_FyhFcS.js";const De={name:"TableForm"},Ie=X({...De,props:{config:{type:Object,default:()=>I()},type:{type:String},editMode:{type:Boolean},disabled:{type:Boolean}},setup(h,{expose:m}){const a=h,v=Y(),i=B({config:I(),form:{},rules:{}});let y;function F(t){v.value&&v.value.validate(u=>{if(u&&t){let r=E.value,c={};if(N.value.forEach(l=>{const p=l.valueType==="string"?[void 0]:["",void 0];let L=r[l.key];p.includes(L)&&(L=null),c[l.key]=L}),r=K(r),c=K(c),y){const l=JSON.parse(JSON.stringify(y));ie(l,r),t(l,c)}else t(r,c)}})}function b(){setTimeout(()=>{var t;(t=v.value)==null||t.clearValidate()})}function j(){i.config.fields.forEach(Q)}function A(t){y=t;const u=[void 0,null,""];i.config.fields.forEach(r=>{if(Object.prototype.hasOwnProperty.call(t,r.key)){const c=re(t,r.key);if(u.includes(c))return;switch(r.type){case"date":O(c,"array")?r.value=c.map(l=>new Date(l)):r.value=new Date(c);break;default:r.value=c;break}}r.defaultValue=U(r.value)}),b()}function M(t){i.config=U(t||I());const u=i.config.fields||[],r={},c={},l=["input","input-between","textarea"];u.forEach(p=>{r[p.key]=p.value,p.required&&(c[p.key]=[{required:!0,validator(L,T,g){const R=[void 0,null,""];if(p.type==="input-between"&&!p.value[0]&&!p.value[1]){g(new Error("请输入两个范围字段"));return}if(p.valueType==="array"&&!p.value.length){g(new Error(p.placeholder||"请选择"));return}if(p.valueType!=="boolean"&&R.includes(p.value)){const z=l.includes(p.type)?"请输入内容":"请选择";g(new Error(p.placeholder||z));return}g()},trigger:l.includes(p.type)?"blur":"change"}])}),i.form=r,i.rules=c,b()}const E=q(()=>{const t={};return i.config.fields.forEach(u=>{t[u.key]=H(u).value}),t}),N=q(()=>i.config.fields.filter(t=>{const u=t.show;if(!u)return!0;if(O(u,"function"))return u(E.value);if(u.includes("return"))try{return new Function("formData",u)(E.value)}catch(r){console.warn("解析表单展示逻辑代码错误 >>",r)}return!0}));function S(t){if(typeof t!="string")return t;if(t.includes("return"))try{return new Function("formData",t)(E.value)}catch(u){console.warn("解析表单项禁用代码错误 >>",u)}}return m({update:M,validate:F,reset:j,setFormData:A}),(t,u)=>{const r=$("el-form-item"),c=$("el-form");return _(),P(c,{ref_key:"formRef",ref:v,model:i.form,rules:i.rules,"label-width":x(W)(i.config.labelWidth),"label-position":i.config.labelPosition,disabled:a.disabled},{default:k(()=>[i.config&&i.config.fields?(_(!0),J(Z,{key:0},G(N.value,l=>(_(),P(r,{key:l.id,label:l.label,prop:l.key},ee({default:k(()=>[w(se,{fieldData:l,disabled:S(l.disabled)},null,8,["fieldData","disabled"])]),_:2},[l.label&&l.tooltip?{name:"label",fn:k(()=>[w(x(ae),{label:l.label,tips:l.tooltip},null,8,["label","tips"])]),key:"0"}:void 0]),1032,["label","prop"]))),128)):V("",!0)]),_:1},8,["model","rules","label-width","label-position","disabled"])}}});function Ne(h){const m=document.createElement("input");m.type="file",m.accept=h.accept||"*",m.multiple=!!h.multiple;const a=h.maxSize,v=i=>D.warning(`上传的文件：【${i.name}】不能大于 ${a}MB`);m.onchange=function(){const i=m.files;if(m.multiple){const y=Array.from(i);if(a){for(const F of y)if(F.size>a*1024*1024)return m.remove(),v(F)}h.change(y)}else{const y=i[0];if(a&&y.size>a*1024*1024)return m.remove(),v(y);h.change(y)}m.remove()},m.style.cssText="position: fixed; top: -200%; left: -200%",document.body.appendChild(m),m.click()}const $e={class:"the-curd-main-page"},Pe=["innerHTML"],je=Ee("i",{class:"el-icon-arrow-left"},null,-1),Be={name:"Curd"},Ae=X({...Be,props:{data:{type:Object,required:!0},action:{type:Object,required:!0},pageId:{type:String,required:!0}},emits:["update:data"],setup(h,{emit:m}){const a=h,v=m,i=B({loading:!1});function y(n){ge({title:"低代码配置",config:a.data,pageId:a.pageId,type:n,callback(e){v("update:data",e)}})}function F(n){n&&a.data.search.list.forEach(Q),b.pageInfo.currentPage=1,b.selectList=[],T()}const b=B({selectList:[],data:[],pageInfo:le()});function j(n){return a.data.table.columns.find(o=>o.prop===n)||{}}function A(n,e){let o="-";const s=j(e);if(!s.jsCode)return o;try{o=new Function("cellValue","row",s.jsCode)(n[e],n)}catch(d){console.warn("解析 rawContent 代码错误 >>",d)}return o}function M(n,e){const o="preview-image-",s=e.replace(o,""),d=[];return N.value.forEach(f=>{f.includes(o)&&d.push(n[f.replace(o,"")])}),{column:j(s),src:n[s],previewList:d}}const E=q(()=>a.data.table.actions.map(e=>{const o={...e};return o.key===ce&&(o.click=function(s){c(s)}),O(o.formConfig,"object")&&(o.click=function(s){c(s,o.formConfig)}),o})),N=q(()=>{const n=[];return a.data.table.columns.forEach(e=>{e.slot&&n.push(e.slot)}),n}),S=Y(),t=B({type:"add",loading:!1,show:!1,config:I()});let u=function(){},r=null;function c(n,e){var f;r=n?JSON.parse(JSON.stringify(n)):{};const o=a.data.table,s=o.formAdd||I(),d=o.formEdit||I();O(e,"object")?(t.config=e,t.type="other"):(t.type=n?"edit":"add",t.config=JSON.parse(JSON.stringify(n?d:s))),t.show=!0,(f=S.value)==null||f.update(t.config),JSON.stringify(r)!=="{}"&&S.value?u=function(){var C;(C=S.value)==null||C.setFormData(r)}:u=function(){}}function l(){var n;(n=S.value)==null||n.reset(),t.show=!1,r=null,g.selects=g.list=[]}function p(){var n;(n=S.value)==null||n.validate(async(e,o)=>{let s;if(t.type==="add"&&a.action.onAdd&&(s=a.action.onAdd),t.type==="edit"&&a.action.onEdit&&(s=a.action.onEdit),s){t.loading=!0;const d=await s(e,o);if(t.loading=!1,d.code!==1)return;l(),T()}else{const d=t.config.submitCode,f=t.config.title?`【${t.config.title}】`:"表单";if(!d)return D.error(`未找到对应的${f}提交代码！`);try{new Function("formData","current","other",d)(e,o,g)}catch(C){console.warn("表单提交代码出错 >>",C)}}})}function L(){const n=a.data.search.list,e={};for(let o=0;o<n.length;o++){const s=n[o],d=H(s);if(s.required&&O(d.result,"string"))return ye(document.querySelector(`.${s.id}`)),D.error(d.result),null;d.result===!0&&(e[s.key]=d.value)}return e}async function T(){const n=L();if(!n)return;const e=a.data.search.validateCode;if(e&&new Function("params",e)(n)===!1)return;const o=JSON.parse(JSON.stringify(b.pageInfo));i.loading=!0;const s=await a.action.getTableData(n,o);i.loading=!1,s.code===1&&(b.pageInfo.total=s.data.total,b.data=s.data.list||[])}const g={selects:[],list:[]};function R(n,e){switch(n){case"add":c();break;case"batch":if(g.selects=JSON.parse(JSON.stringify(b.selectList)),!g.selects.length)return D.warning("请选择要操作的列！");if(!e)return D.error("当前按钮未配置动态代码或表单配置！");if(g.list=g.selects.map(o=>o[a.data.table.selectKey]),O(e,"object")){c(void 0,e);return}if(O(e,"function")){e(g.list,g.selects);return}try{new Function("list","selectList",e)(g.list,g.selects)}catch(o){console.warn("批量操作代码出错 >>",o)}break;case"open-form":c(void 0,e);break}}const z={};function te(n){i.loading=n}function ne(n){t.loading=n}function oe(){const n={},e=[void 0,null,""];return a.data.search.list.forEach(o=>{const s=o.value;e.includes(s)||(n[o.key]=s)}),n}return ue({formatDate:Ce,copyText:Se,messageBox:ke,message:D,jsonToPath:_e,request:we,onUploadFile:Ne,downloadFile:ve,getCountId:he,jsonToHtml:be,[a.pageId]:{onSearch:F,getData:T,setLoading:te,setFormLoading:ne,openForm:c,closeForm:l,cellFn:z,getSearchParams:oe}}),Fe(function(){a.action.created&&a.data.table.columns.length&&a.action.created(T)}),(n,e)=>{const o=$("el-button"),s=$("el-empty"),d=$("base-dialog");return _(),J("div",$e,[a.data.search.list.length?(_(),P(fe,{key:0,search:a.data.search,loading:i.loading,onSearch:F},null,8,["search","loading"])):V("",!0),a.data.table.columns.length>0?(_(),J(Z,{key:1},[w(de,{config:a.data.table,disabled:i.loading,onAction:R},null,8,["config","disabled"]),w(x(Le),{class:"f1","select-list":b.selectList,"onUpdate:selectList":e[0]||(e[0]=f=>b.selectList=f),data:b.data,columns:a.data.table.columns,actions:E.value,"action-max":a.data.table.actionMax,loading:i.loading,"select-key":a.data.table.selectKey,"page-info":b.pageInfo,onPage:e[1]||(e[1]=f=>T()),onSort:e[2]||(e[2]=f=>T())},ee({_:2},[G(N.value,f=>({name:f,fn:k(({row:C})=>[f.includes("preview-image-")?(_(),P(x(pe),Te(Oe({key:0},M(C,f))),null,16)):V("",!0),f.includes("render-cell-")?(_(),J("div",{key:1,innerHTML:A(C,f.replace("render-cell-",""))},null,8,Pe)):V("",!0)])}))]),1032,["select-list","data","columns","actions","action-max","loading","select-key","page-info"])],64)):(_(),P(s,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:k(()=>[w(o,{type:"primary",onClick:e[3]||(e[3]=f=>y("table"))},{default:k(()=>[xe("去配置")]),_:1})]),_:1})),w(o,{class:"the-curd-entrance",type:"primary",size:"small",onClick:e[4]||(e[4]=f=>y())},{default:k(()=>[je]),_:1}),w(d,{show:t.show,"onUpdate:show":e[5]||(e[5]=f=>t.show=f),title:t.config.title,width:x(W)(t.config.width),onClose:l,onOpened:x(u)},{footer:k(()=>[w(x(me),{loading:t.loading,onClose:l,onSubmit:p},null,8,["loading"])]),default:k(()=>[w(Ie,{ref_key:"formRef",ref:S,disabled:t.loading},null,8,["disabled"])]),_:1},8,["show","title","width","onOpened"])])}}});export{Ae as _};
