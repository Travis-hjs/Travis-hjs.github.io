import{g as U,q as G,u as W,w as Q,x as X,y as Y,T as Z,z as ee,A as te,B as oe,C as ne,D as ae,a as y,b as $,E as se,G as ie,H as le,I as re,c as ce,f as fe}from"./index-DrlxBw3b.js";import{r as de}from"./common-LVi3Tbgp.js";import{d as ue,r as B,f as b,g as pe,n as ge,o as me,b as h,h as x,j as w,l as D,p as N,c as d,F as ye,q as m,t as ve,v as be,s as j,u as I,e as he,y as we}from"./element-plus-HQxsU011.js";const _e={class:"the-curd-main-page"},ke={key:0,class:"the-tag blue"},Le=we("i",{class:"el-icon-arrow-left"},null,-1),Ce={name:"Curd"},Ie=ue({...Ce,props:{data:{type:Object,required:!0},action:{type:Object,required:!0}},emits:["update:data"],setup(q,{emit:O}){const i=q,V=O,u=B({loading:!1});function E(t){ne({title:"低代码配置",config:i.data,type:t,callback(e){V("update:data",e)}})}function A(t){t&&i.data.search.list.forEach(ae),o.pageInfo.currentPage=1,o.selectList=[],g()}const o=B({selectList:[],data:[],pageInfo:U(),formShow:!1,formType:"add",formLoading:!1}),r=b(()=>i.data.table),L=b(()=>r.value.columns.filter(e=>e.visible).map(e=>{const n={...e};return n.cellType==="js"&&n.jsCode&&(n.rawContent=function(l,p){let c="";try{c=new Function("cellValue","row",n.jsCode)(l,p)}catch(a){console.warn("解析 rawContent 代码错误 >>",a),c="-"}return c}),n})),P=b(()=>r.value.actions.map(e=>{const n={...e};return n.key===G&&(n.click=F),n})),C=b(()=>{const t=[],e=[];return L.value.forEach(n=>{n.slotHead&&t.push(n.slotHead),n.slot&&e.push(n.slot)}),{head:t,cell:e}});function J(t){return r.value.columns.find(n=>n.prop===t)||{}}const v=pe(),S=b(()=>{const t=r.value,e={title:"编辑表单",config:t.formEdit||{}};return o.formType==="add"&&(e.title="新增表单",e.config=t.formAdd||{}),e});let _=null;function F(t){t?(o.formType="edit",_=t):o.formType="add",o.formShow=!0,setTimeout(()=>{var e;return(e=v.value)==null?void 0:e.clear()}),ge(()=>{var e;return _&&((e=v.value)==null?void 0:e.setFormData(_))})}function k(){var t;o.formShow=!1,(t=v.value)==null||t.reset(),_=null}function K(){var t;(t=v.value)==null||t.validate(async(e,n)=>{if(o.formType==="add"&&i.action.onAdd){o.formLoading=!0;const l=await i.action.onAdd(e,n);if(o.formLoading=!1,l.code!==1)return;k(),g()}if(o.formType==="edit"&&i.action.onEdit){o.formLoading=!0;const l=await i.action.onEdit(e,n);if(o.formLoading=!1,l.code!==1)return;k(),g()}})}function M(t){const e=i.data.search.list,n={};for(let a=0;a<e.length;a++){const s=e[a],f=se(s);if(s.required&&ie(f.result,"string"))return le(document.querySelector(`.${s.id}`)),y.error(f.result),t&&t.key==="page"&&(o.pageInfo=t.before),null;f.result===!0&&(n[s.key]=f.value)}const l=r.value.columns,p=[],c=[];return t&&t.key==="sort"?l.forEach(a=>{a.sort&&(a.prop===t.prop?a.sort=t.action:a.sort=!0),a.sort==="asc"&&p.push(a.prop),a.sort==="desc"&&c.push(a.prop)}):l.forEach(a=>{a.sort==="asc"&&p.push(a.prop),a.sort==="desc"&&c.push(a.prop)}),p.length&&(n.asc=p.toString()),c.length&&(n.desc=c.toString()),n}async function g(t){const e=M(t);if(!e)return;const n=JSON.parse(JSON.stringify(o.pageInfo));u.loading=!0;const l=await i.action.getTableData(e,n);u.loading=!1,l.code===1&&(o.pageInfo.total=l.data.total,o.data=l.data.list||[])}function H(t){const e=o.selectList;switch(t){case"add":F();break;case"delete":if(!e.length)return y.warning("请选择要删除的列表再进行操作~");$({title:"操作提示",content:`是否删除选中的 ${e.length} 条数据？`,cancelText:"取消",async confirm(){i.action.onDelete?(u.loading=!0,(await i.action.onDelete(JSON.parse(JSON.stringify(o.selectList)))).code===1?(y.success("删除成功！"),o.selectList=[],g()):u.loading=!1):y.info("请设置 action.onDelete 删除逻辑")}});break;case"export":i.action.onExport?i.action.onExport():y.info("请设置 action.onExport 导出逻辑");break}}function R(t){u.loading=t}return W({formatDate:fe,copyText:ce,messageBox:$,message:y,jsonToPath:re,request:de,getData:g,setLoading:R}),me(function(){i.action.created&&r.value.columns.length&&i.action.created(g)}),(t,e)=>{const n=h("base-table"),l=h("base-pagination"),p=h("el-button"),c=h("el-empty"),a=h("base-dialog");return w(),x("div",_e,[i.data.search.list.length?(w(),D(Q,{key:0,search:i.data.search,loading:u.loading,onSearch:A},null,8,["search","loading"])):N("",!0),r.value.columns.length>0?(w(),x(ye,{key:1},[d(X,{config:r.value,disabled:u.loading,onAction:H},{left:m(()=>[r.value.selectKey?(w(),x("span",ke," 已选择 "+ve(o.selectList.length)+" 条数据 ",1)):N("",!0)]),_:1},8,["config","disabled"]),d(n,{class:"f1","select-list":o.selectList,"onUpdate:selectList":e[1]||(e[1]=s=>o.selectList=s),data:o.data,columns:L.value,actions:P.value,actionMax:r.value.actionMax,loading:u.loading,"select-key":r.value.selectKey},be({_:2},[j(C.value.head,s=>({name:s,fn:m(({$index:f})=>[d(Y,{column:L.value[r.value.selectKey?f-1:f],onSort:e[0]||(e[0]=(T,z)=>g({key:"sort",prop:T,action:z}))},null,8,["column"])])})),j(C.value.cell,s=>({name:s,fn:m(({row:f})=>[d(I(Z),{column:J(s),src:f[s],previewList:C.value.cell.map(T=>f[T])},null,8,["column","src","previewList"])])}))]),1032,["select-list","data","columns","actions","actionMax","loading","select-key"]),d(l,{disabled:u.loading,pageInfo:o.pageInfo,onChange:e[2]||(e[2]=s=>g({key:"page",...s}))},null,8,["disabled","pageInfo"])],64)):(w(),D(c,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:m(()=>[d(p,{type:"primary",onClick:e[3]||(e[3]=s=>E("table"))},{default:m(()=>[he("去配置")]),_:1})]),_:1})),d(p,{class:"the-curd-entrance",type:"primary",size:"small",onClick:e[4]||(e[4]=s=>E())},{default:m(()=>[Le]),_:1}),d(a,{show:o.formShow,"onUpdate:show":e[7]||(e[7]=s=>o.formShow=s),title:S.value.title,width:I(oe)(S.value.config.width),onClose:e[8]||(e[8]=s=>k())},{footer:m(()=>[d(I(te),{loading:o.formLoading,onClose:e[5]||(e[5]=s=>k()),onSubmit:e[6]||(e[6]=s=>K())},null,8,["loading"])]),default:m(()=>[d(ee,{ref_key:"formRef",ref:v,config:S.value.config,type:o.formType,disabled:o.formLoading},null,8,["config","type","disabled"])]),_:1},8,["show","title","width"])])}}});export{Ie as _};
