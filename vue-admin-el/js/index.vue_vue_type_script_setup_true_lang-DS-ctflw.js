import{z as x,A as K,B as j,C as U,D as ee,E as W,k as z,g as te,x as ne,G as oe,H as ae,I as se,T as re,J as ie,K as le,a as k,b as H,L as ce,M as ue,c as fe,f as de}from"./index-C6esjatS.js";import{d as G,x as Q,r as P,g as T,b as D,k as F,i as v,u as C,m as h,h as B,j as J,F as X,l as Y,c as b,o as pe,A as me,C as ge,s as ye,e as ve,p as be}from"./element-plus-DM0gVeuf.js";import{r as he}from"./common-c-70Uaoz.js";import{_ as _e}from"./Table.vue_vue_type_script_setup_true_lang-CcxVgS3s.js";const we={name:"TableForm"},ke=G({...we,props:{config:{type:Object,default:()=>x()},type:{type:String},editMode:{type:Boolean},disabled:{type:Boolean}},setup(V,{expose:q}){const u=V,S=Q(),r=P({config:x(),form:{},rules:{}});function O(s){var n;(n=S.value)==null||n.validate(o=>{if(o&&s){let m=_.value,f={};N.value.forEach(i=>{f[i.key]=m[i.key]}),s(m,f)}})}function L(){setTimeout(()=>{var s;(s=S.value)==null||s.clearValidate()})}function p(){r.config.fields.forEach(W)}function g(s){r.config.fields.forEach(n=>{if(Object.prototype.hasOwnProperty.call(s,n.key)){const o=s[n.key];if(!o)return;switch(n.type){case"date":j(o,"array")?n.value=o.map(m=>new Date(m)):n.value=new Date(o);break;default:n.value=o;break}}n.defaultValue=z(n.value)}),L()}function $(s){r.config=z(s||x());const n=r.config.fields||[],o={},m={},f=["input","input-between","textarea"];n.forEach(i=>{o[i.key]=i.value,i.required&&(m[i.key]=[{required:!0,validator(I,R,w){const y=[void 0,null,""];if(i.type==="input-between"&&!i.value[0]&&!i.value[1]){w(new Error("请输入两个范围字段"));return}if(i.valueType==="array"&&!i.value.length){w(new Error(i.placeholder||"请选择"));return}if(i.valueType!=="boolean"&&y.includes(i.value)){const M=f.includes(i.type)?"请输入内容":"请选择";w(new Error(i.placeholder||M));return}w()},trigger:f.includes(i.type)?"blur":"change"}])}),r.form=o,r.rules=m,L()}const _=T(()=>{const s={};return r.config.fields.forEach(n=>{s[n.key]=K(n).value}),s}),N=T(()=>r.config.fields.filter(s=>{const n=s.show;if(!n)return!0;if(j(n,"function"))return n(_.value);if(n.includes("return"))try{return new Function("formData",n)(_.value)}catch(o){console.warn("解析表单展示逻辑代码错误 >>",o)}return!0}));function A(s){if(typeof s!="string")return s;if(s.includes("return"))try{return new Function("formData",s)(_.value)}catch(n){console.warn("解析表单项禁用代码错误 >>",n)}}return q({update:$,validate:O,reset:p,setFormData:g}),(s,n)=>{const o=D("el-form-item"),m=D("el-form");return v(),F(m,{ref_key:"formRef",ref:S,model:r.form,rules:r.rules,"label-width":C(U)(r.config.labelWidth),"label-position":r.config.labelPosition,disabled:u.disabled},{default:h(()=>[r.config&&r.config.fields?(v(!0),B(X,{key:0},Y(N.value,f=>(v(),F(o,{key:f.id,label:f.label,prop:f.key},{default:h(()=>[b(ee,{fieldData:f,disabled:A(f.disabled)},null,8,["fieldData","disabled"])]),_:2},1032,["label","prop"]))),128)):J("",!0)]),_:1},8,["model","rules","label-width","label-position","disabled"])}}}),Ce={class:"the-curd-main-page"},xe=["innerHTML"],Se=be("i",{class:"el-icon-arrow-left"},null,-1),Ee={name:"Curd"},Le=G({...Ee,props:{data:{type:Object,required:!0},action:{type:Object,required:!0}},emits:["update:data"],setup(V,{emit:q}){const u=V,S=q,r=P({loading:!1});function O(t){le({title:"低代码配置",config:u.data,type:t,callback(e){S("update:data",e)}})}function L(t){t&&u.data.search.list.forEach(W),p.pageInfo.currentPage=1,p.selectList=[],y()}const p=P({selectList:[],data:[],pageInfo:te()}),g=T(()=>u.data.table);function $(t){return g.value.columns.find(a=>a.prop===t)||{}}function _(t,e){let a="-";const l=$(e);if(!l.jsCode)return a;try{a=new Function("cellValue","row",l.jsCode)(t[e],t)}catch(d){console.warn("解析 rawContent 代码错误 >>",d)}return a}function N(t,e){const a="preview-image-",l=e.replace(a,""),d=[];return s.value.forEach(c=>{c.includes(a)&&d.push(t[c.replace(a,"")])}),{column:$(l),src:t[l],previewList:d}}const A=T(()=>g.value.actions.map(e=>{const a={...e};return a.key===ne&&(a.click=function(l){i(l)}),a})),s=T(()=>{const t=[];return g.value.columns.forEach(e=>{e.slot&&t.push(e.slot)}),t}),n=Q(),o=P({type:"add",loading:!1,show:!1,config:x()});let m=function(){},f=null;function i(t,e){var c;f=t?JSON.parse(JSON.stringify(t)):{};const a=g.value,l=a.formAdd||x(),d=a.formEdit||x();j(e,"object")?(o.config=e,o.type="other"):(o.type=t?"edit":"add",o.config=JSON.parse(JSON.stringify(t?d:l))),o.show=!0,(c=n.value)==null||c.update(o.config),JSON.stringify(f)!=="{}"&&n.value?m=function(){var E;(E=n.value)==null||E.setFormData(f)}:m=function(){}}function I(){var t;o.show=!1,(t=n.value)==null||t.reset(),f=null}function R(){var t;(t=n.value)==null||t.validate(async(e,a)=>{let l;if(o.type==="add"&&u.action.onAdd&&(l=u.action.onAdd),o.type==="edit"&&u.action.onEdit&&(l=u.action.onEdit),l){o.loading=!0;const d=await l(e,a);if(o.loading=!1,d.code!==1)return;I(),y()}})}function w(){const t=u.data.search.list,e={};for(let a=0;a<t.length;a++){const l=t[a],d=K(l);if(l.required&&j(d.result,"string"))return ce(document.querySelector(`.${l.id}`)),k.error(d.result),null;d.result===!0&&(e[l.key]=d.value)}return e}async function y(){const t=w();if(!t)return;const e=JSON.parse(JSON.stringify(p.pageInfo));r.loading=!0;const a=await u.action.getTableData(t,e);r.loading=!1,a.code===1&&(p.pageInfo.total=a.data.total,p.data=a.data.list||[])}function M(t){const e=p.selectList;switch(t){case"add":i();break;case"delete":if(!e.length)return k.warning("请选择要删除的列表再进行操作~");H({title:"操作提示",content:`是否删除选中的 ${e.length} 条数据？`,cancelText:"取消",async confirm(){u.action.onDelete?(r.loading=!0,(await u.action.onDelete(JSON.parse(JSON.stringify(p.selectList)))).code===1?(k.success("删除成功！"),p.selectList=[],y()):r.loading=!1):k.info("请设置 action.onDelete 删除逻辑")}});break;case"export":u.action.onExport?u.action.onExport():k.info("请设置 action.onExport 导出逻辑");break}}function Z(t){r.loading=t}return oe({formatDate:de,copyText:fe,messageBox:H,message:k,jsonToPath:ue,request:he,getData:y,setLoading:Z}),pe(function(){u.action.created&&g.value.columns.length&&u.action.created(y)}),(t,e)=>{const a=D("el-button"),l=D("el-empty"),d=D("base-dialog");return v(),B("div",Ce,[u.data.search.list.length?(v(),F(ae,{key:0,search:u.data.search,loading:r.loading,onSearch:L},null,8,["search","loading"])):J("",!0),g.value.columns.length>0?(v(),B(X,{key:1},[b(se,{config:g.value,disabled:r.loading,onAction:M},null,8,["config","disabled"]),b(C(_e),{class:"f1","select-list":p.selectList,"onUpdate:selectList":e[0]||(e[0]=c=>p.selectList=c),data:p.data,columns:g.value.columns,actions:A.value,"action-max":g.value.actionMax,loading:r.loading,"select-key":g.value.selectKey,"page-info":p.pageInfo,onPage:e[1]||(e[1]=c=>y()),onSort:e[2]||(e[2]=c=>y())},me({_:2},[Y(s.value,c=>({name:c,fn:h(({row:E})=>[c.includes("preview-image-")?(v(),F(C(re),ge(ye({key:0},N(E,c))),null,16)):J("",!0),c.includes("render-cell-")?(v(),B("div",{key:1,innerHTML:_(E,c.replace("render-cell-",""))},null,8,xe)):J("",!0)])}))]),1032,["select-list","data","columns","actions","action-max","loading","select-key","page-info"])],64)):(v(),F(l,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:h(()=>[b(a,{type:"primary",onClick:e[3]||(e[3]=c=>O("table"))},{default:h(()=>[ve("去配置")]),_:1})]),_:1})),b(a,{class:"the-curd-entrance",type:"primary",size:"small",onClick:e[4]||(e[4]=c=>O())},{default:h(()=>[Se]),_:1}),b(d,{show:o.show,"onUpdate:show":e[7]||(e[7]=c=>o.show=c),title:o.config.title,width:C(U)(o.config.width),onClose:I,onOpened:C(m)},{footer:h(()=>[b(C(ie),{loading:o.loading,onClose:e[5]||(e[5]=c=>I()),onSubmit:e[6]||(e[6]=c=>R())},null,8,["loading"])]),default:h(()=>[b(ke,{ref_key:"formRef",ref:n,disabled:o.loading},null,8,["disabled"])]),_:1},8,["show","title","width","onOpened"])])}}});export{Le as _};
