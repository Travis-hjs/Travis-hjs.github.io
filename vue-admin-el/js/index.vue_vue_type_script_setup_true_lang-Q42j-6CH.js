import{g as R,w as z,y as M,z as U,A as G,B as W,T as Q,C as X,D as Y,E as Z,G as ee,H as te,a as y,b as I,I as oe,J as ne,K as ae,L as se,c as ie,f as le}from"./index-Da4p7Ns4.js";import{r as re}from"./common-BExHir9j.js";import{_ as ce}from"./Table.vue_vue_type_script_setup_true_lang-CnEKXaiR.js";import{d as fe,r as $,g as h,x as de,v as ue,o as pe,b as _,h as F,i as k,k as B,j as ge,c,F as me,A as ye,l as N,m as g,u as L,e as ve,p as he}from"./element-plus-D8VYLuQe.js";const be={class:"the-curd-main-page"},we=he("i",{class:"el-icon-arrow-left"},null,-1),ke={name:"Curd"},_e=fe({...ke,props:{data:{type:Object,required:!0},action:{type:Object,required:!0}},emits:["update:data"],setup(j,{emit:A}){const i=j,D=A,f=$({loading:!1});function x(t){ee({title:"低代码配置",config:i.data,type:t,callback(e){D("update:data",e)}})}function O(t){t&&i.data.search.list.forEach(te),n.pageInfo.currentPage=1,n.selectList=[],d()}const n=$({selectList:[],data:[],pageInfo:R(),formShow:!1,formType:"add",formLoading:!1}),r=h(()=>i.data.table),C=h(()=>r.value.columns.filter(e=>e.visible).map(e=>{const o={...e};return o.cellType==="js"&&o.jsCode&&(o.rawContent=function(l,u){let s="";try{s=new Function("cellValue","row",o.jsCode)(l,u)}catch(a){console.warn("解析 rawContent 代码错误 >>",a),s="-"}return s}),o})),P=h(()=>r.value.actions.map(e=>{const o={...e};return o.key===z&&(o.click=E),o})),S=h(()=>{const t=[],e=[];return C.value.forEach(o=>{o.slotHead&&t.push(o.slotHead),o.slot&&e.push(o.slot)}),{head:t,cell:e}});function V(t){return r.value.columns.find(o=>o.prop===t)||{}}const v=de(),T=h(()=>{const t=r.value,e={title:"编辑表单",config:t.formEdit||{}};return n.formType==="add"&&(e.title="新增表单",e.config=t.formAdd||{}),e});let b=null;function E(t){t?(n.formType="edit",b=t):n.formType="add",n.formShow=!0,setTimeout(()=>{var e;return(e=v.value)==null?void 0:e.clear()}),ue(()=>{var e;return b&&((e=v.value)==null?void 0:e.setFormData(b))})}function w(){var t;n.formShow=!1,(t=v.value)==null||t.reset(),b=null}function q(){var t;(t=v.value)==null||t.validate(async(e,o)=>{if(n.formType==="add"&&i.action.onAdd){n.formLoading=!0;const l=await i.action.onAdd(e,o);if(n.formLoading=!1,l.code!==1)return;w(),d()}if(n.formType==="edit"&&i.action.onEdit){n.formLoading=!0;const l=await i.action.onEdit(e,o);if(n.formLoading=!1,l.code!==1)return;w(),d()}})}function J(t){const e=i.data.search.list,o={};for(let a=0;a<e.length;a++){const p=e[a],m=oe(p);if(p.required&&ne(m.result,"string"))return ae(document.querySelector(`.${p.id}`)),y.error(m.result),t&&t.key==="page"&&(n.pageInfo=t.before),null;m.result===!0&&(o[p.key]=m.value)}const l=r.value.columns,u=[],s=[];return t&&t.key==="sort"?l.forEach(a=>{a.sort&&(a.prop===t.prop?a.sort=t.action:a.sort=!0),a.sort==="asc"&&u.push(a.prop),a.sort==="desc"&&s.push(a.prop)}):l.forEach(a=>{a.sort==="asc"&&u.push(a.prop),a.sort==="desc"&&s.push(a.prop)}),u.length&&(o.asc=u.toString()),s.length&&(o.desc=s.toString()),o}async function d(t){const e=J(t);if(!e)return;const o=JSON.parse(JSON.stringify(n.pageInfo));f.loading=!0;const l=await i.action.getTableData(e,o);f.loading=!1,l.code===1&&(n.pageInfo.total=l.data.total,n.data=l.data.list||[])}function K(t){const e=n.selectList;switch(t){case"add":E();break;case"delete":if(!e.length)return y.warning("请选择要删除的列表再进行操作~");I({title:"操作提示",content:`是否删除选中的 ${e.length} 条数据？`,cancelText:"取消",async confirm(){i.action.onDelete?(f.loading=!0,(await i.action.onDelete(JSON.parse(JSON.stringify(n.selectList)))).code===1?(y.success("删除成功！"),n.selectList=[],d()):f.loading=!1):y.info("请设置 action.onDelete 删除逻辑")}});break;case"export":i.action.onExport?i.action.onExport():y.info("请设置 action.onExport 导出逻辑");break}}function H(t){f.loading=t}return M({formatDate:le,copyText:ie,messageBox:I,message:y,jsonToPath:se,request:re,getData:d,setLoading:H}),pe(function(){i.action.created&&r.value.columns.length&&i.action.created(d)}),(t,e)=>{const o=_("el-button"),l=_("el-empty"),u=_("base-dialog");return k(),F("div",be,[i.data.search.list.length?(k(),B(U,{key:0,search:i.data.search,loading:f.loading,onSearch:O},null,8,["search","loading"])):ge("",!0),r.value.columns.length>0?(k(),F(me,{key:1},[c(G,{config:r.value,disabled:f.loading,onAction:K},null,8,["config","disabled"]),c(L(ce),{class:"f1","select-list":n.selectList,"onUpdate:selectList":e[1]||(e[1]=s=>n.selectList=s),data:n.data,columns:C.value,actions:P.value,"action-max":r.value.actionMax,loading:f.loading,"select-key":r.value.selectKey,"page-info":n.pageInfo,onPage:e[2]||(e[2]=s=>d({key:"page",...s}))},ye({_:2},[N(S.value.head,s=>({name:s,fn:g(({$index:a})=>[c(W,{column:C.value[r.value.selectKey?a-1:a],onSort:e[0]||(e[0]=(p,m)=>d({key:"sort",prop:p,action:m}))},null,8,["column"])])})),N(S.value.cell,s=>({name:s,fn:g(({row:a})=>[c(L(Q),{column:V(s),src:a[s],previewList:S.value.cell.map(p=>a[p])},null,8,["column","src","previewList"])])}))]),1032,["select-list","data","columns","actions","action-max","loading","select-key","page-info"])],64)):(k(),B(l,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:g(()=>[c(o,{type:"primary",onClick:e[3]||(e[3]=s=>x("table"))},{default:g(()=>[ve("去配置")]),_:1})]),_:1})),c(o,{class:"the-curd-entrance",type:"primary",size:"small",onClick:e[4]||(e[4]=s=>x())},{default:g(()=>[we]),_:1}),c(u,{show:n.formShow,"onUpdate:show":e[7]||(e[7]=s=>n.formShow=s),title:T.value.title,width:L(Z)(T.value.config.width),onClose:e[8]||(e[8]=s=>w())},{footer:g(()=>[c(L(Y),{loading:n.formLoading,onClose:e[5]||(e[5]=s=>w()),onSubmit:e[6]||(e[6]=s=>q())},null,8,["loading"])]),default:g(()=>[c(X,{ref_key:"formRef",ref:v,config:T.value.config,type:n.formType,disabled:n.formLoading},null,8,["config","type","disabled"])]),_:1},8,["show","title","width"])])}}});export{_e as _};
