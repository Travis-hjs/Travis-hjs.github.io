import{K as P,L as J,M as T,N as Q,O as se,P as re,Q as W,R as X,S as ie,q as L,a as $,e as le,D as V,U as ce,V as ue,W as de,X as fe,Y as pe,Z as ge,$ as me,a0 as be,t as ye,a1 as he,a2 as ve,a3 as we,b as _e,c as ke,f as Ie}from"./index-C0DSbLpf.js";import{d as Y,x as Z,r as A,g as N,b as B,k as O,i as I,u as E,m as C,h as M,j as R,F as G,l as ee,A as te,c as k,o as Ce,C as xe,s as Fe,e as Te,p as Ee}from"./element-plus-Cfes4v7f.js";import{_ as Le}from"./Table.vue_vue_type_script_setup_true_lang-CyTxesT7.js";const Se={name:"TableForm"},De=Y({...Se,props:{config:{type:Object,default:()=>P()},type:{type:String},editMode:{type:Boolean},disabled:{type:Boolean},pageId:{type:String,required:!0}},setup(v,{expose:g}){const n=v,w=Z(),i=A({config:P(),form:{},rules:{}});let b;function x(t){w.value&&w.value.validate(u=>{if(u&&t){let r=S.value,c={};if(j.value.forEach(l=>{const p=l.valueType==="string"?[void 0]:["",void 0];let D=r[l.key];p.includes(D)&&(D=null),c[l.key]=D}),r=W(r),c=W(c),b){const l={...r,...L(b,!0)};t(l,c)}else t(r,c)}})}function y(){setTimeout(()=>{var t;(t=w.value)==null||t.clearValidate()})}function q(){i.config.fields.forEach(X)}function z(t){b=t;const u=[void 0,null,""];i.config.fields.forEach(r=>{if(Object.prototype.hasOwnProperty.call(t,r.key)){const c=ie(t,r.key);if(u.includes(c))return;switch(r.type){case"date":T(c,"array")?r.value=c.map(l=>new Date(l)):r.value=new Date(c);break;default:r.value=c;break}}r.defaultValue=L(r.value)}),y()}function K(t){i.config=L(t||P());const u=i.config.fields||[],r={},c={},l=["input","input-between","textarea"];u.forEach(p=>{r[p.key]=p.value,p.required&&(c[p.key]=[{required:!0,validator(D,F,m){const U=[void 0,null,""];if(p.type==="input-between"&&!p.value[0]&&!p.value[1]){m(new Error("请输入两个范围字段"));return}if(p.valueType==="array"&&!p.value.length){m(new Error(p.placeholder||"请选择"));return}if(p.valueType!=="boolean"&&U.includes(p.value)){const H=l.includes(p.type)?"请输入内容":"请选择";m(new Error(p.placeholder||H));return}m()},trigger:l.includes(p.type)?"blur":"change"}])}),i.form=r,i.rules=c,y()}const S=N(()=>{const t={};return i.config.fields.forEach(u=>{t[u.key]=J(u).value}),t}),j=N(()=>i.config.fields.filter(t=>{const u=t.show;if(!u)return!0;if(T(u,"function"))return u(S.value);if(u.includes("return"))try{return new Function("sandbox",u)({formData:S.value,pageId:n.pageId})}catch(r){console.warn("解析表单展示逻辑代码错误 >>",r)}return!0}));function _(t){if(typeof t!="string")return t;if(t.includes("return"))try{return new Function("sandbox",t)({formData:S.value,pageId:n.pageId})}catch(u){console.warn("解析表单项禁用代码错误 >>",u)}}return g({update:K,validate:x,reset:q,setFormData:z}),(t,u)=>{const r=B("el-form-item"),c=B("el-form");return I(),O(c,{ref_key:"formRef",ref:w,model:i.form,rules:i.rules,"label-width":E(Q)(i.config.labelWidth),"label-position":i.config.labelPosition,disabled:n.disabled},{default:C(()=>[i.config&&i.config.fields?(I(!0),M(G,{key:0},ee(j.value,l=>(I(),O(r,{key:l.id,label:l.label,prop:l.key},te({default:C(()=>[k(re,{fieldData:l,disabled:_(l.disabled)},null,8,["fieldData","disabled"])]),_:2},[l.label&&l.tooltip?{name:"label",fn:C(()=>[k(E(se),{label:l.label,tips:l.tooltip},null,8,["label","tips"])]),key:"0"}:void 0]),1032,["label","prop"]))),128)):R("",!0)]),_:1},8,["model","rules","label-width","label-position","disabled"])}}});function $e(v){const g=document.createElement("input");g.type="file",g.accept=v.accept||"*",g.multiple=!!v.multiple;const n=v.maxSize,w=i=>$.warning(`上传的文件：【${i.name}】不能大于 ${n}MB`);g.onchange=function(){const i=g.files;if(g.multiple){const b=Array.from(i);if(n){for(const x of b)if(x.size>n*1024*1024)return g.remove(),w(x)}v.change(b)}else{const b=i[0];if(n&&b.size>n*1024*1024)return g.remove(),w(b);v.change(b)}g.remove()},g.style.cssText="position: fixed; top: -200%; left: -200%",document.body.appendChild(g),g.click()}const Pe={class:"the-curd-main-page"},je=["innerHTML"],Be=Ee("i",{class:"el-icon-arrow-left"},null,-1),Oe={name:"Curd"},Me=Y({...Oe,props:{data:{type:Object,required:!0},action:{type:Object,required:!0},pageId:{type:String,required:!0}},emits:["update:data"],setup(v,{emit:g}){const n=v,w=g,i=A({loading:!1});function b(a){ge({title:"低代码配置",config:n.data,pageId:n.pageId,type:a,callback(e){w("update:data",e)}})}function x(a){a&&n.data.search.list.forEach(X),y.pageInfo.currentPage=1,y.selectList=[],F()}const y=A({selectList:[],data:[],pageInfo:le()});function q(a){return n.data.table.columns.find(o=>o.prop===a)||{}}function z(a,e){let o="-";const s=q(e);if(!s.jsCode)return o;try{o=new Function("sandbox",s.jsCode)({cellValue:a[e],row:a,pageId:n.pageId})}catch(f){console.warn("解析 rawContent 代码错误 >>",f)}return o}function K(a,e){const o="preview-image-",s=e.replace(o,""),f=[];return j.value.forEach(d=>{d.includes(o)&&f.push(a[d.replace(o,"")])}),{column:q(s),src:a[s],previewList:f}}const S=N(()=>n.data.table.actions.map(e=>{const o={...e};return o.key===V.ActionEdit&&(o.click=function(s){c(s)}),T(o.formConfig,"object")&&(o.click=function(s){c(s,o.formConfig)}),o})),j=N(()=>{const a=[];return n.data.table.columns.forEach(e=>{e.slot&&a.push(e.slot)}),a}),_=Z(),t=A({type:"add",loading:!1,show:!1,config:P()});let u=function(){},r=null;function c(a,e){var d;r=a?L(a,!0):{};const o=n.data.table,s=o.formAdd||P(),f=o.formEdit||P();T(e,"object")?(t.config=e,t.type="other"):(t.type=a?"edit":"add",t.config=L(a?f:s,!0)),t.show=!0,(d=_.value)==null||d.update(t.config),JSON.stringify(r)!=="{}"&&_.value?u=function(){var h;(h=_.value)==null||h.setFormData(r)}:u=function(){var h;(h=_.value)==null||h.setFormData({})}}function l(){var a;(a=_.value)==null||a.reset(),t.show=!1,r=null,m.selects=m.list=[]}function p(){var a;(a=_.value)==null||a.validate(async(e,o)=>{let s;if(t.type==="add"&&n.action.onAdd&&(s=n.action.onAdd),t.type==="edit"&&n.action.onEdit&&(s=n.action.onEdit),s){t.loading=!0;const f=await s(e,o);if(t.loading=!1,f.code!==1)return;l(),F()}else{const f=t.config.submitCode,d=t.config.title?`【${t.config.title}】`:"表单";if(!f)return $.error(`未找到对应的${d}提交代码！`);try{new Function("sandbox",f)({formData:e,current:o,batch:m,pageId:n.pageId})}catch(h){console.warn("表单提交代码出错 >>",h)}}})}function D(){const a=n.data.search.list,e={};for(let o=0;o<a.length;o++){const s=a[o],f=J(s);if(s.required&&T(f.result,"string"))return me(document.querySelector(`.${s.id}`)),$.error(f.result),null;f.result===!0&&(e[s.key]=f.value)}return e}async function F(){const a=D();if(!a)return;const e=n.data.search.validateCode;if(e&&new Function("sandbox",e)({params:a,pageId:n.pageId})===!1)return;const o=L(y.pageInfo,!0);i.loading=!0;const s=await n.action.getTableData(a,o);i.loading=!1,s.code===1&&(y.pageInfo.total=s.data.total,y.data=s.data.list||[])}const m={selects:[],list:[]};function U(a,e){switch(a){case V.Add:c();break;case V.Batch:if(m.selects=L(y.selectList,!0),!m.selects.length)return $.warning("请选择要操作的列！");if(!e)return $.error("当前按钮未配置动态代码或表单配置！");m.list=m.selects.map(s=>s[n.data.table.selectKey]);const o={list:m.list,selectList:m.selects,pageId:n.pageId};if(T(e,"object")){c(void 0,e);return}if(T(e,"function")){e(o);return}try{new Function("sandbox",e)(o)}catch(s){console.warn("批量操作代码出错 >>",s)}break;case V.OpenForm:c(void 0,e);break}}const H={};function ne(a){i.loading=a}function ae(a){t.loading=a}function oe(){const a={},e=[void 0,null,""];return n.data.search.list.forEach(o=>{const s=o.value;e.includes(s)||(a[o.key]=s)}),a}return ce({formatDate:Ie,copyText:ke,messageBox:_e,message:$,jsonToPath:we,request:ve,onUploadFile:$e,downloadFile:he,getCountId:ye,jsonToHtml:be,[n.pageId]:{onSearch:x,getData:F,setLoading:ne,setFormLoading:ae,openForm:c,closeForm:l,cellFn:H,getSearchParams:oe}}),Ce(function(){n.action.created&&n.data.table.columns.length&&n.action.created(F)}),(a,e)=>{const o=B("el-button"),s=B("el-empty"),f=B("base-dialog");return I(),M("div",Pe,[n.data.search.list.length?(I(),O(ue,{key:0,search:n.data.search,loading:i.loading,onSearch:x},null,8,["search","loading"])):R("",!0),n.data.table.columns.length>0?(I(),M(G,{key:1},[k(de,{config:n.data.table,disabled:i.loading,"page-id":n.pageId,onAction:U},null,8,["config","disabled","page-id"]),k(E(Le),{class:"f1","select-list":y.selectList,"onUpdate:selectList":e[0]||(e[0]=d=>y.selectList=d),data:y.data,columns:n.data.table.columns,actions:S.value,"action-max":n.data.table.actionMax,loading:i.loading,"select-key":n.data.table.selectKey,"page-info":y.pageInfo,"page-id":n.pageId,onPage:e[1]||(e[1]=d=>F()),onSort:e[2]||(e[2]=d=>F())},te({_:2},[ee(j.value,d=>({name:d,fn:C(({row:h})=>[d.includes("preview-image-")?(I(),O(E(fe),xe(Fe({key:0},K(h,d))),null,16)):R("",!0),d.includes("render-cell-")?(I(),M("div",{key:1,innerHTML:z(h,d.replace("render-cell-",""))},null,8,je)):R("",!0)])}))]),1032,["select-list","data","columns","actions","action-max","loading","select-key","page-info","page-id"])],64)):(I(),O(s,{key:2,description:"当前页面没有表格配置数据，请配置后再操作~"},{default:C(()=>[k(o,{type:"primary",onClick:e[3]||(e[3]=d=>b("table"))},{default:C(()=>[Te("去配置")]),_:1})]),_:1})),k(o,{class:"the-curd-entrance",type:"primary",size:"small",onClick:e[4]||(e[4]=d=>b())},{default:C(()=>[Be]),_:1}),k(f,{show:t.show,"onUpdate:show":e[5]||(e[5]=d=>t.show=d),title:t.config.title,width:E(Q)(t.config.width),onClose:l,onOpened:E(u)},{footer:C(()=>[k(E(pe),{loading:t.loading,onClose:l,onSubmit:p},null,8,["loading"])]),default:C(()=>[k(De,{ref_key:"formRef",ref:_,disabled:t.loading,"page-id":n.pageId},null,8,["disabled","page-id"])]),_:1},8,["show","title","width","onOpened"])])}}});export{Me as _};
